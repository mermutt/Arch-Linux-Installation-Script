- block:
  - name: "Check for ADM CPU"
    lineinfile:
      path: /proc/cpuinfo
      regexp: '.*AMD.*'
      state: absent
    check_mode: yes
    register: amd_cpu

  - name: "Check for Intel CPU"
    lineinfile:
      path: /proc/cpuinfo
      regexp: '.*Intel.*'
      state: absent
    check_mode: yes
    register: intel_cpu

  - name: "Set fact has_amd_cpu"
    set_fact:
      has_amd_cpu: "{{ amd_cpu.found > 0 }}"

  - name: "Set fact has_intel_cpu"
    set_fact:
      has_intel_cpu: "{{ intel_cpu.found > 0 }}"

  - name: "Show has_intel_cpu fact"
    debug:
      var: has_intel_cpu

  - name: "Show has_amd_cpu fact"
    debug:
      var: has_amd_cpu

- block:
  # superuser

  - name: "Create data partition on {{ install_device }}"
    community.general.parted:
      device: "/dev/{{ install_device }}"
      name: "{{ part_label_data }}"
      label: gpt
      number: 3
      part_type: primary
      state: present
      part_start: "{{ root_partition_end }}"
      part_end: "100%"

  - name: "Ensure to recreate LUKS container {{ crypt_label_data }}"
    community.crypto.luks_device:
      device: "/dev/disk/by-partlabel/{{ part_label_data }}"
      state: "absent"
      name: "{{ crypt_label_data }}"
    ignore_errors: true

  - name: "Create LUKS container {{ crypt_label_data }} for {{ part_label_data }}"
    community.crypto.luks_device:
      device: "/dev/disk/by-partlabel/{{ part_label_data }}"
      state: "opened"
      name: "{{ crypt_label_data }}"
      passphrase: "{{ luks_passphrase }}"
      hash: "sha512"
      type: luks1
      pbkdf:
        iteration_count: "{{ luks_pbkdf_iterations }}"

  - name: "Add Keyfile to LUKS container {{ crypt_label_data }}"
    community.crypto.luks_device:
      device: "/dev/disk/by-partlabel/{{ part_label_data }}"
      state: "opened"
      passphrase: "{{ luks_passphrase }}"
      new_keyfile: "{{ install_path}}{{ luks_keyfile }}"

  # longhorn reuires a ext4 filesystem (btrfs is currently not supported)
  - name: "Create ext4 Filesystem"
    community.general.filesystem:
      fstype: ext4
      dev: "/dev/mapper/{{ crypt_label_data }}"
      opts: "-L {{ ext4_label_data }}"
      force: true

  become: true
  when: create_ext4_data_partition

- block:
  # superuser

  - name: "Create nix directories"
    file:
      path: "{{ item }}"
      state: 'directory'
      mode: 0755
    with_items:
      - "{{ install_path }}/nix/persistent"
      - "{{ install_path }}/nix/persistent/etc"
      - "{{ install_path }}/nix/persistent/etc/nixos"
      - "{{ install_path }}/nix/persistent/etc/ssh"
      - "{{ install_path }}/etc"
      - "{{ install_path }}/etc/nixos"

  - name: "Bind mount /nix/persistent/etc/nixos -> /etc/nixos"
    mount:
      path: "{{ install_path }}/etc/nixos"
      src: "{{ install_path }}/nix/persistent/etc/nixos"
      fstype: none
      opts: 'bind'
      state: "mounted"
      fstab: /tmp/tmp.fstab

  - name: "Create NixOS hardware-config"
    template:
      src: hardware-configuration.nix.j2
      dest: "{{ install_path }}/etc/nixos/hardware-configuration.nix"
      owner: root
      group: root
      mode: 0755

  - name: "Create NixOS minimal config"
    template:
      src: configuration.nix.j2
      dest: "{{ install_path }}/etc/nixos/configuration.nix"
      owner: root
      group: root
      mode: 0755

  - name: "Install NixOS"
    shell:
      cmd: nixos-install --no-root-passwd --root {{ install_path }}
      chdir: "{{ install_path }}"

  become: true

